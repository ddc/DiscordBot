services:
  discordbot_alembic:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: discordbot_alembic
    restart: always
    env_file: .env
    environment:
      DOCKER_BUILDKIT: 1
    networks:
      - postgres_network
    command: ["sh", "-c", "uv run --frozen alembic upgrade head && touch /tmp/alembic_done && sleep infinity"]
    deploy:
      restart_policy:
        delay: 60s
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/alembic_done"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 120s

  discordbot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - LOG_DIRECTORY=${LOG_DIRECTORY}
    container_name: discordbot
    restart: always
    env_file: .env
    volumes:
        - ${LOG_DIRECTORY}:${LOG_DIRECTORY}
    networks:
      - postgres_network
    depends_on:
      discordbot_alembic:
        condition: service_healthy
    deploy:
      restart_policy:
        delay: 60s
    command: ["uv", "run", "--frozen", "python", "-m", "src"]

networks:
  postgres_network:
    external: true
