services:
  bot_alembic:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bot_alembic
    restart: always
    env_file: .env
    environment:
      DOCKER_BUILDKIT: 1
    command: ["sh", "-c", "uv run alembic -c config/alembic.ini upgrade head && touch /tmp/alembic_done && sleep infinity"]
    depends_on:
      bot_db:
        condition: service_healthy
    deploy:
      restart_policy:
        delay: 180s
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/alembic_done"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 120s

  bot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - LOG_DIRECTORY=${LOG_DIRECTORY}
    container_name: bot
    restart: always
    env_file: .env
    volumes:
        - ${LOG_DIRECTORY}:${LOG_DIRECTORY}
    depends_on:
      bot_alembic:
        condition: service_healthy
    command: ["uv", "run", "python", "/app/bot.py"]

volumes:
  bot_db_data:
    name: "bot_db_data"
